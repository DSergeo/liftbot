{% extends "layout.html" %}

{% block title %}–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ - –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.analytics-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.chart-container {
    position: relative;
    height: 400px;
    padding: 20px;
}

.metric-card {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
    border: none;
    border-radius: 20px;
    padding: 25px;
    color: white;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.metric-card.success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.metric-card.warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.metric-card.danger {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
}

.activity-timeline {
    max-height: 500px;
    overflow-y: auto;
}

.timeline-item {
    border-left: 3px solid var(--bs-primary);
    padding-left: 20px;
    margin-bottom: 20px;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bs-primary);
}

.filter-buttons .btn {
    border-radius: 25px;
    margin: 5px;
    font-weight: 500;
}

.refresh-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.pulse {
    animation: pulse 2s infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-white mb-1">
                <i class="fas fa-chart-bar me-3"></i>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
            </h1>
            <p class="text-muted mb-0">–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –∑–≤—ñ—Ç–∏ –ø–æ –∑–∞—è–≤–∫–∞–º</p>
        </div>
        <div class="filter-buttons">
            <button class="btn btn-outline-light active" data-period="7">7 –¥–Ω—ñ–≤</button>
            <button class="btn btn-outline-light" data-period="30">30 –¥–Ω—ñ–≤</button>
            <button class="btn btn-outline-light" data-period="all">–í–µ—Å—å —á–∞—Å</button>
        </div>
    </div>

    <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <i class="fas fa-clipboard-list fa-2x mb-3"></i>
                <div class="stat-value" id="totalRequests">0</div>
                <p class="mb-0">–í—Å—å–æ–≥–æ –∑–∞—è–≤–æ–∫</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card success">
                <i class="fas fa-check-circle fa-2x mb-3"></i>
                <div class="stat-value" id="completedRequests">0</div>
                <p class="mb-0">–í–∏–∫–æ–Ω–∞–Ω–æ</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card warning">
                <i class="fas fa-clock fa-2x mb-3"></i>
                <div class="stat-value" id="pendingRequests">0</div>
                <p class="mb-0">–û—á—ñ–∫—É—é—Ç—å</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <div class="stat-value" id="errorRequests">0</div>
                <p class="mb-0">–ü—Ä–æ–±–ª–µ–º–Ω—ñ</p>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="row mb-4">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (Pie Chart) -->
        <div class="col-lg-6 mb-4">
            <div class="analytics-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-chart-pie me-2"></i>–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                </h4>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–π–æ–Ω–∞–º (Bar Chart) -->
        <div class="col-lg-6 mb-4">
            <div class="analytics-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-map-marker-alt me-2"></i>–ó–∞—è–≤–∫–∏ –ø–æ —Ä–∞–π–æ–Ω–∞—Ö
                </h4>
                <div class="chart-container">
                    <canvas id="districtChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º (Line Chart) -->
        <div class="col-lg-8 mb-4">
            <div class="analytics-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-chart-line me-2"></i>–î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞—è–≤–æ–∫ (–æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤)
                </h4>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º (Bar Chart) -->
        <div class="col-lg-4 mb-4">
            <div class="analytics-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-clock me-2"></i>–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø–æ –≥–æ–¥–∏–Ω–∞—Ö
                </h4>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-history me-2"></i>–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
                </h4>
                <div class="activity-timeline" id="activityTimeline">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<button class="refresh-btn" id="refreshData" title="–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ">
    <i class="fas fa-sync-alt"></i>
</button>
{% endblock %}

{% block scripts %}
<script>
let charts = {};
let analyticsData = {};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    setupEventListeners();
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadAnalyticsData, 30000);
});

function setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    document.getElementById('refreshData').addEventListener('click', function() {
        this.classList.add('pulse');
        loadAnalyticsData();
        setTimeout(() => this.classList.remove('pulse'), 1000);
    });

    // –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
    document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-buttons .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        });
    });
}

async function loadAnalyticsData() {
    try {
        const response = await fetch('/analytics/data');
        analyticsData = await response.json();
        
        updateMetrics();
        updateCharts();
        updateActivityTimeline();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ dashboard.js)
window.updateAnalyticsCharts = function() {
    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏–∑-–∑–∞ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫');
    loadAnalyticsData();
};

// –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
window.addEventListener('newRequestAdded', function(event) {
    console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É');
    loadAnalyticsData();
});

function updateMetrics() {
    const { status_stats, total_requests } = analyticsData;
    
    document.getElementById('totalRequests').textContent = total_requests || 0;
    document.getElementById('completedRequests').textContent = status_stats?.done || 0;
    document.getElementById('pendingRequests').textContent = status_stats?.pending || 0;
    document.getElementById('errorRequests').textContent = status_stats?.error || 0;
}

function updateCharts() {
    createStatusChart();
    createDistrictChart();
    createDailyChart();
    createHourlyChart();
}

function createStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (charts.status) charts.status.destroy();
    
    const { status_stats } = analyticsData;
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['–í–∏–∫–æ–Ω–∞–Ω–æ', '–û—á—ñ–∫—É—é—Ç—å', '–ü—Ä–æ–±–ª–µ–º–Ω—ñ'],
            datasets: [{
                data: [
                    status_stats?.done || 0,
                    status_stats?.pending || 0,
                    status_stats?.error || 0
                ],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ],
                borderWidth: 3,
                borderColor: '#1a1a1a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: 'white', font: { size: 14 } }
                }
            }
        }
    });
}

function createDistrictChart() {
    const ctx = document.getElementById('districtChart').getContext('2d');
    
    if (charts.district) charts.district.destroy();
    
    const { district_stats } = analyticsData;
    const labels = Object.keys(district_stats || {});
    const data = Object.values(district_stats || {});
    
    charts.district = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—è–≤–æ–∫',
                data: data,
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderColor: '#0d6efd',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

function createDailyChart() {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    if (charts.daily) charts.daily.destroy();
    
    const { daily_stats } = analyticsData;
    const labels = daily_stats?.map(d => d.date) || [];
    const data = daily_stats?.map(d => d.count) || [];
    
    charts.daily = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ó–∞—è–≤–∫–∏ –ø–æ –¥–Ω—è—Ö',
                data: data,
                borderColor: '#20c997',
                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#20c997',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

function createHourlyChart() {
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    
    if (charts.hourly) charts.hourly.destroy();
    
    const { hourly_stats } = analyticsData;
    const labels = hourly_stats?.map(h => h.hour) || [];
    const data = hourly_stats?.map(h => h.count) || [];
    
    charts.hourly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–ó–∞—è–≤–∫–∏',
                data: data,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: '#ffc107',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        stepSize: 1
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxRotation: 45
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

function updateActivityTimeline() {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    const timeline = document.getElementById('activityTimeline');
    timeline.innerHTML = `
        <div class="timeline-item">
            <div class="d-flex justify-content-between">
                <h6 class="text-white mb-1">–ó–∞—è–≤–∫–∞ –æ–±—Ä–æ–±–ª–µ–Ω–∞</h6>
                <small class="text-muted">5 —Ö–≤ —Ç–æ–º—É</small>
            </div>
            <p class="text-muted mb-0">–≤—É–ª. –õ–∞–∑—É—Ä–Ω–∞, 30 - –ø—Ä–æ–±–ª–µ–º—É –≤–∏—Ä—ñ—à–µ–Ω–æ</p>
        </div>
        <div class="timeline-item">
            <div class="d-flex justify-content-between">
                <h6 class="text-white mb-1">–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞</h6>
                <small class="text-muted">15 —Ö–≤ —Ç–æ–º—É</small>
            </div>
            <p class="text-muted mb-0">–≤—É–ª. –û–∫–µ–∞–Ω—ñ–≤—Å—å–∫–∞, 40 - –ª—ñ—Ñ—Ç –Ω–µ –ø—Ä–∞—Ü—é—î</p>
        </div>
        <div class="timeline-item">
            <div class="d-flex justify-content-between">
                <h6 class="text-white mb-1">–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏</h6>
                <small class="text-muted">1 –≥–æ–¥ —Ç–æ–º—É</small>
            </div>
            <p class="text-muted mb-0">–í–∏–∫–æ–Ω–∞–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö</p>
        </div>
    `;
}
</script>
{% endblock %}